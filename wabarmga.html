<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>barmga</title>
</head>
<body>
   <div class="data"></div>
   <div class="report"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    
    <script>
start()
async function start(){
var data=document.querySelector('.data')
var mindelay=Math.max(localStorage.getItem('wabarmgamindelay'),1)
var maxdelay=Math.max(2,localStorage.getItem('wabarmgamaxdelay'))
var dicto=getData("wabarmga","wabarmga")
var status=localStorage.getItem("wabarmgastatus")
data.setAttribute('data-status',status)
data.setAttribute('data-mindelay',mindelay)
data.setAttribute('data-maxdelay',maxdelay)
var database=await getData('wabarmga','wabarmga')

for (let num of Object.keys(database)){
  console.log(num)

  if(num=="id"){continue}
  let newel=document.createElement("span")
  newel.setAttribute('data-phone',num)
  newel.setAttribute('data-message',data[num])
  data.appendChild(newel)
}}
async function saveData(dbName, storeName, data) {
  return new Promise((resolve, reject) => {
    let request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = function(event) {
      let db = event.target.result;
      if (!db.objectStoreNames.contains(storeName)) {
        db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
      }
    };

    request.onsuccess = function(event) {
      let db = event.target.result;
      let transaction = db.transaction(storeName, "readwrite");
      let store = transaction.objectStore(storeName);

      store.clear();

      if (Array.isArray(data)) {
        data.forEach(item => {
          store.put(item);
        });
      } else {
        store.put(data);
      }

      transaction.oncomplete = function() {
        resolve("Data saved or updated successfully");
      };

      transaction.onerror = function() {
        reject("Error saving or updating data");
      };
    };

    request.onerror = function() {
      reject("Error opening database");
    };
  });
}

async function getDataAsync(dbName, storeName) {
  return new Promise((resolve, reject) => {
    let request = indexedDB.open(dbName, 1);

    request.onsuccess = function(event) {
      let db = event.target.result;
      let transaction = db.transaction(storeName, "readonly");
      let store = transaction.objectStore(storeName);
      let data = {};

      store.openCursor().onsuccess = function(event) {
        let cursor = event.target.result;
        if (cursor) {
          Object.assign(data, cursor.value);
          cursor.continue();
        } else {
          resolve(data);
        }
      };

      transaction.onerror = function() {
        reject("Error retrieving data");
      };
    };

    request.onerror = function() {
      reject("Error opening database");
    };
  });
}

async function getData(dbName, storeName) {
  try {
    const data = await getDataAsync(dbName, storeName);
    return data;
  } catch (error) {
    console.error(error);
    return {};
  }
}
function updatereportall(){
  let report={}
  let spans=document.querySelector('.report').querySelectorAll('span')
  for (let el of spans){
     report[el.getAttribute('data-phone')=el.getAttribute('data-sent')]
  }
  saveData('wabarmgareport','wabarmgareport',report)
}
function checkStatus() {
    const interval = setInterval(() => {
        const status = localStorage.getItem('wabarmgastatus');
        updatereportall()
        if (status === 'stop') {
            document.querySelector('.data').setAttribute('data-status','stop')
            console.log('Status is stop');
            clearInterval(interval);
            if (document.querySelector('[download]')){
              var ellels=document.querySelector('[download]').querySelectorAll("span")
              var reported={}
              for (let span of ellels){reported[span.getAttribute('data-phone')]=span.getAttribute('data-sent')}
              saveData("wabarmgareport","wabarmgareport",reported)
            return;}
        }
    }, 5000);
}

// Call the function to start checking
checkStatus();

</script>
<script>
  var newel=document.createElement('a');
  newel.setAttribute('class','wabarmga');
  newel.setAttribute('style', "display:none;");
  document.body.appendChild(newel);
  var stopornot = false;
  var mainFuncCalled = false; // Add a flag to indicate if mainFunc has been called
  var sendcss='[aria-label="Send"]'
  var iframe = document.createElement('iframe');
  iframe.setAttribute('style', "display:none;");
  iframe.setAttribute('id', "myifra");
  iframe.setAttribute('src', "https://barmga.com/wabramga");
  document.body.appendChild(iframe);
  
  iframe.onload = function() {
    var iframeWindow = iframe.contentWindow;
    
    var checkDataElement = setInterval(function() {
      var dataElement = iframeWindow.document.querySelector('.data');
      
      if (dataElement) {
        clearInterval(checkDataElement);
        
        setTimeout(function() {
          var status = dataElement.getAttribute('data-status');
          
          if (status === 'working' && !mainFuncCalled) { // Check if mainFunc has already been called
            mainFuncCalled = true; // Set the flag to true to prevent multiple calls
            var dataDict = {};
            var spans = dataElement.querySelectorAll('span');
            
            spans.forEach(function(span) {
              var phone = span.getAttribute('data-phone');
              var message = span.getAttribute('data-message');
              dataDict[phone] = message;
            });
            
            var minDelay = parseInt(dataElement.getAttribute('data-mindelay'));
            var maxDelay = parseInt(dataElement.getAttribute('data-maxdelay'));
            
            // Call main function
            mainFunc(dataDict, minDelay, maxDelay);
          }
        }, 3000); // Wait for 3 seconds
      }
    }, 500); // Check every 500ms

    // Function to check status every 5 seconds
  };
  function getRandomFloat(min, max) {
    return Math.random() * (max - min) + min;
}
function checkiframestop(){
  if(iframe.contentWindow.document.querySelector('.data').getAttribute('data-status')=="stop"){stopornot=true}
}
function updatereport(phone,status){
  var span = iframe.contentWindow.document.createElement('span');
          span.setAttribute('data-phone', phone);
          span.setAttribute('data-sent', status);
          iframe.contentWindow.document.querySelector('.report').appendChild(span);
}
 async function mainFunc(dataDict, minDelay, maxDelay) {
  for (let phone of Object.keys(dataDict)){
  document.querySelector('a.wabarmga').setAttribute('href','https://wa.me/'+phone+"?text="+dataDict[phone])
  document.querySelector('a.wabarmga').click()
  let xi=0
  while(document.querySelector(sendcss)==null){await new Promise((resolve) => setTimeout(resolve,getRandomFloat(490,510)));xi++;await checkiframestop(); if (xi>11||stopornot){break}}
  if(stopornot){return}
  if (xi>11){updatereport(phone,"failure");continue}
  document.querySelector(sendcss).click()
  updatereport(phone,"success")
  let i=0
  let maxsleep=getRandomFloat(parseInt(minDelay),parseInt(maxDelay))
  while(i*500<maxsleep && !stopornot){await new Promise((resolve) => setTimeout(resolve,getRandomFloat(490,510)));i++}
    if(stopornot){return}
}
  }
</script>


</body></html>


